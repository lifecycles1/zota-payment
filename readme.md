# Zota Payment Integration Project

## Overview

This project integrates with the Zota payment gateway, providing a seamless payment experience through client-side flow with redirects. The architecture consists of a React/Vite frontend, a Golang backend, and ngrok for secure tunneling. The Go API serves as a proxy to the Zota API, handling deposit requests and order status queries. The frontend interacts with this Go API and provides a user interface for initiating and managing payments.

## API Endpoints

### Flowless Endpoints

1. **Deposit Request**

   - **URL**: `/api/v1/deposit/request/{endpointID}/`
   - **Method**: POST
   - **Description**: Creates a deposit request and returns the response from Zota.
   - **Body Parameters**: JSON payload required by Zota.

2. **Order Status Request**
   - **URL**: `/api/v1/query/order-status/`
   - **Method**: GET
   - **Description**: Checks the order status. The user needs to retry until a final status is obtained.
   - **Query Parameters**:
     - `merchantID`
     - `orderID`
     - `merchantOrderID`
     - `timestamp`
     - `signature`

### Flow Endpoints

3. **Client Flow with Redirects**

   - **URL**: `/api/v1/deposit/client-flow/{endpointID}/`
   - **Method**: POST
   - **Description**: Initiates the deposit process, redirects the user to Zota's deposit page, and handles the final status via client-side polling.

4. **Callback Endpoint**

   - **URL** `baseURL generated by ngrok(updates automatically in .env)`+`/api/v1/payment-callback/`
   - **Method**: POST
   - **Description**: Accepts and records the final status for any given order.
   - **Body Parameters**: JSON payload sent by Zota.

## Setup Instructions

### Prerequisites

1. **Linux**: Please run on Linux since Kafka was added to the project.
2. **ngrok**: Download and install ngrok from the [official website](https://ngrok.com/).
3. **Node.js**: Ensure Node.js is installed for running the frontend.
4. **Go**: Ensure Go is installed for running the backend.
5. **Kafka**: Ensure Kafka is installed. It has some prerequisites: Java runtime versions 11 or 17.
6. **PostgreSQL**: Ensure PostgreSQL is installed.

### Installation and Startup Steps

1. **Install ngrok and Set Up Authentication**

   - Install ngrok and add the folder path to your system's PATH. On Linux can install via Snap, then relaunch terminal and should work automatically. Can also verify successful installation by checking version:

   ```bash
   snap install ngrok
   ngrok --version
   ```

   - Register at the ngrok website to obtain an auth token.

   - Open `ngrok/ngrok.yml` and update the `authtoken` with your ngrok auth token.

   ```yaml
   authtoken: your-ngrok-auth-token
   ```

2. **Assuming you have kafka installed**

   - Topic creation is automated and always checks for existence before attempting.

3. **Assuming you have PostgreSQL installed**

4. **Setup and Run**

   - Navigate to the `client` directory and install dependencies:

   ```bash
   cd client
   npm install
   ```

   - Start ngrok from the `client` directory:

   ```bash
   npm run start:ngrok
   ```

   - Run the frontend: open another terminal, navigate to the `client` directory, and start the development server:

   ```bash
   cd client
   npm run dev
   ```

   - Run your kafka server in KRaft mode: open a third terminal, navigate to your local kafka installation directory and start your kafka server (topic will be created automatically). Also, please generate and provide a cluster id to the KRaft mode configs:

   Run the kafka-storage.sh script to generate a cluster ID:

   ```bash
   KAFKA_CLUSTER_ID="$(bin/kafka-storage.sh random-uuid)"
   ```

   Run the kafka-storage.sh script again to format the log directories:

   ```bash
   bin/kafka-storage.sh format -t $KAFKA_CLUSTER_ID -c config/kraft/server.properties
   ```

   Run the kafka-server-start.sh script to start the Kafka server in KRaft mode:

   ```bash
   bin/kafka-server-start.sh config/kraft/server.properties
   ```

   - Run the backend: open a fourth terminal, navigate to the `server` directory, and run the Go application:

   ```bash
   cd server
   go run main.go
   ```

   - Launch the application:
     - Open your browser and go to http://localhost:5173 to interact with the frontend.
     - Test the deposit flow or the single endpoints through the frontend interface. Please run the Client Flow twice because the first time the browser will prompt you to trust ngrok and will cause conflicts. Resolve by refreshing the browser and running the Client Flow again which will then work as expected.
     - All endpoints except 'Client Flow' can also be tested with tools like Postman, Insomnia, etc.

## Testing Endpoints

### Test through frontend client, Postman or similar tools

1. **Deposit Request**

   - **URL**: `http://localhost:8080/api/v1/deposit/request/{endpointID}/`
   - **Method**: POST
   - **Body**: JSON payload required by Zota.

2. **Order Status Request**
   - **URL**: `http://localhost:8080/api/v1/query/order-status/`
   - **Method**: GET
   - **Query Params**:
     - `merchantID`
     - `merchantOrderID`
     - `orderID`
     - `timestamp`
     - `signature`

## Testing Flow

### Test `Client Flow` through frontend client only.

1. **Testing the Client Flow**

   - Trigger the deposit request from the frontend.
   - Observe the frontend handling the redirects to Zota's deposit page.
   - Complete the payment process.
   - Zota redirects back to frontend's PaymentReturn redirect url which displays the order status results and keeps polling for a final status.

## Additional Tests - Please run all unit/integration/end-to-end tests on front- and backend while keeping all terminals running, otherwise will fail.

### Run Tests on Frontend with Vitest/React Testing Library

1. **Unit/Integration/End-to-end**

   - Navigate to `client` directory, run the test command, then observe the results:

   ```bash
   cd client
   npm run test
   ```

### Run Tests on Backend with Built-in Testing library and Testify

2. **Integration**

   - Navigate to `server` directory, run the test command to recursively find and run all test files in the backend project. Include verbose flag:

   ```bash
   cd server
   go test -v ./...
   ```
